/*!
 * viaProxy.js JavaScript Library 0.2pre
 * http://semanticsworks.com
 *
 * Copyright 2011, Fred Yang
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/gpl-2.0
 *
 * Date: Wed Dec 21 22:32:20 2011 -0500
 */
 window.jQuery&&window.via||function(g,la,j){function I(c){this.context=r(c||"",!0)}function v(c){return"object"===typeof c}function n(c){return"string"===typeof c}function Q(c){return null===c||typeof c in Ja}function R(c){return c===j}function x(c,a){0===a&&(a="0");var b,d,e=S,f=T(c,a),g=r(f,!0),h=g.split(".");if(1===h.length)d=g;else{d=h[h.length-1];for(b=0;b<h.length-1&&!(e=e[h[b]],e===j);b++);}if(Q(e))throw"invalid access proxy using path:"+f;return{physicalPath:g,logicalPath:f,hostObj:e,index:d}}
function U(c){this.mainPath=c}function r(c,a){if(!c)return"";if("*"===c)return l;var b=c.split("*");if(1===b.length)return c;var d=b[0],b=b[1],e=d.replace(ba,"_");if(a&&d){var f=l+"."+e;!ma[e]&&k.get(d)!==j&&k.create(f,new U(d))}return!e?l+"."+b:b?l+"."+e+"."+b:l+"."+e}function na(c){if(c===l)return"*";var a=Ka.exec(c);return a&&a[1]?a[2]?a[1].replace(ca,".")+"*"+a[3]:a[1].replace(ca,".")+"*":c}function V(c,a,b,d){var e,f=c.lastIndexOf(".");b&&(-1===f?(b="",e=c):(b=c.substring(0,f),e=c.substring(f+
1)),d(b,e,a));if(!Q(a))for(e in a)z.call(a,e)&&(d(c,e,a[e]),V(c+"."+e,a[e],!1,d))}function oa(c,a,b){if(o(b))for(var b=b.toString(),d,e,f,g;(d=La.exec(b))&&(e=d[1]);)c?(f=c+"."+a,g=c+"."+e):(f=a,g=e),m[g]=m[g]||[],m[g].pushUnique(f)}function T(c,a){return!a?c:c?c+(a.toString().beginsWith("*")?a:"."+a):a}function pa(c){var a,b,d=p[c.path];if(d)for(b=0;b<d.length;b++){a=d[b];if(qa(a.modelEvents,c.eventType))c.options=a.options,da(a.view,a.modelHandler,c);if(!c.continueEventing)return}if((a=m[c.path])&&
a.length)for(d=0;d<a.length;d++){b=s(a[d],a[d],c.eventType,c.proposed===j?j:k.get(!0,a[d]));if(!b.continueEventing)break;if(b.hasError)c.hasError=!0}}function da(c,a,b){c===ea&&(c=null);if(o(a))return a.call(c,b);if(n(a)){var d=a.substring(1),e=a.substring(2);if(a.beginsWith("*")){if(d=w[d])return d.call(c,b)}else if(a.beginsWith("$")){if(o(A[d])){a=b.currentValue();if("css,attr,prop".contains(d))b=b.options||b.targetIndex(),g(c)[d](b,a);else g(c)[d](a&&a.toString());return}}else if(a.beginsWith("v.")&&
c[e]){a=b.currentValue();if(o(c[e]))c[e](a);else c[e]=a;return}}throw"handler: "+a+" not found";}function qa(c,a){var b;if("*"===c)return!0;for(var c=c.split(ra),d=0;d<c.length;d++){b=c[d];if(b===a)return!0;if(b=Ma.exec(b))if(b[4])if(b[1]){if(B("^"+b[1]+"\\w*\\."+b[4]).test(a))return!0}else{if(B("^\\w+\\."+b[4]).test(a))return!0}else if(b[3]){if(b=b[1]?B("^"+b[1]+"(?!\\w*\\.\\w+)"):Na,b.test(a))return!0}else if(a.beginsWith(b[1]))return!0}return!1}function C(c,a,b,d,e){v(c)?i(this,c):(this.path=c,
this.target=a,this.eventType=b,!R(d)&&(this.proposed=d),!R(e)&&(this.removed=e))}function sa(c,a,b){n(a)&&a.beginsWith("*")&&(a=w[a.substring(1)]);o(a.buildOptions)&&(b=a.buildOptions.call(c,b));return b}function fa(c){g(c).data(l,!0)}function W(c){return!0===g(c).data(l)}function J(c,a,b,d){v(c)?i(this,c):(this.path=c,this.options=a,this.e=b,this.triggerData=d)}function Oa(c,a){var b=c.data,d=new J(b.path,b.options,c,a),b=b.viewHandler;if(o(b))return X(d,b.call(this,d));if(n(b)){var e=b.substring(1),
f=b.substring(2);if(b.beginsWith("*")){if(e=K[e]){e.call(this,d);return}}else if(b.beginsWith("$")){if(o(A[e]))return X(d,"css,attr,prop".contains(e)?g(this)[e](d.options||d.targetIndex()):g(this)[e]())}else if(b.beginsWith("p.")){if(o(D[f])){d.targetProxy()[f](d);return}}else if(b.beginsWith("v.")){if(e=this[f],o(e))return X(d,e.call(this,d))}else if(b.beginsWith("m.")&&(e=k.get(!0,f),o(e)))return X(d,e.call(this,d))}throw"view handler: '"+b+"' not found";}function X(c,a){if(a!==j){var b=c.options;
n(b)&&b.beginsWith("*")&&(b=ga[b.substring(1)])&&(a=b(a));k.update(c.path,a)}}function ta(c){var a=c.data,b=g(c.target).data("via");(b=b&&b.viewEvents&&b.viewEvents[a])&&g(c.target).trigger(i({},c,{type:a+"."+b,currentTarget:c.target}))}function ua(c){if(!n(c))throw"bindingText must non-empty string";for(var a={},b,d;b=Pa.exec(c);)d=b[1],b=b[3]&&g.trim(b[3])||!0,a[d]=a[d]?a[d]+";"+b:b;return a}function Qa(c){if(!c)return!1;var a;a:{a=c+".";for(var b in L)if(b.beginsWith(a)){a=!0;break a}a=!1}if(a)return!0;
a=va(c);if(!a)return!1;b=0;for(var d;d=a[b];b++)for(var e in d){var f=d[e],g=c+"."+e;L[g]=L[g]?L[g]+f:f}return!0}function va(c){var a=h.themes[c];if(a){c=[];a.bindingSet&&c.push(a.bindingSet);if(a=a.subThemes)for(var a=a.split(";"),b=0;b<a.length;b++)c=c.concat(va(a[b]));return c}}function wa(c,a,b){if(a[M]&&"_"!==a[M]&&Qa(a.theme))for(var d=a[M].split(Ra),e,f=0;f<d.length;f++){var g=Sa.exec(d[f]);if(e=L[a.theme+"."+g[1]]){e=ua(e);e.path=xa(a.path,g[3]);e.theme=a.theme;e.options=g[5]||a.options;wa(c,
e,b);var g=c,h=e,i=b;Y("mh",g,h,i);Y("vh",g,h,i);ya(c,e,b)}}}function za(c){for(c=g(c);(c=c.parent())&&c.length;){var a=c.data("via");if(a&&a.path)return a.path}return""}function Y(c,a,b,d){var e,f,g,h;if(h=b[c]&&b[c].replace(Ta,"").split(";"))for(e=0;e<h.length;e++)if(f=Ua.exec(h[e]))g=xa(b.path,f[1]),d[c].push("mh"===c?{path:g,modelEvents:f[2],view:a,modelHandler:f[3],options:f[5]||b.options}:{path:g,viewEvents:f[2],view:a,viewHandler:f[3],options:f[5]||b.options})}function ya(c,a,b){var d,e;for(e in a)z.call(a,
e)&&!Va.contains(e)&&(d=y[e])&&d(c,a,b,a[e])}function Aa(c,a,b,d,e){e=e||d&&d.engine||q.engine;if(!e)throw"there is not default engine registered";var f,h=d&&(g.isFunction(d)?d:d.callback),i=E[e||d&&d.engine||q.engine],d=d||{};d.get=function(a){return k.get(a)};if(!i)throw"engine '"+i+"' can not be found.";if(i.isTemplateCompiled(a))return f=g(i.renderTemplate(a,b,d)),h&&h.call(c,f),f;if("undefined"!==typeof matrix){var j=g.Deferred();matrix(matrix.resourceName(a)+".template").done(function(){f=g(i.renderTemplate(a,
b,d));j.resolve(f)});return j.promise().done(function(){h&&h.call(c,f)})}throw"can not locate template for '"+a+"'";}function Ba(c){g(this).html(c);c.view()}function ha(c){var a=c.currentValue();if(a&&(N(a)&&a.length||!N(a))){var c=c.options,b=c.callback;c.callback=b?function(a){Ba.call(this,a);b.call(this,a)}:Ba;Aa(this,c.templateId,a,c)}else g(this).empty()}function Ca(c){var a=c.currentValue();c.currentValue=function(){return[a]};ha.call(this,c)}function Da(c){if(""===c)return!Z.length;for(var a=
c+".",b=0;b<Z.length;b++)if(Z[b]==c||Z[b].beginsWith(a))return!1;return!0}function Ea(c){g.each(ia.call(arguments,1),function(a,b){c=c.replace(new B("\\{"+a+"\\}","g"),b)});return c}function Fa(c){var a=function(a){var d,e;if(null===a.proposed||a.proposed===j||Wa.test(a.proposed)){a:{d=a.path;d=r(d);d=p[d];for(var f=0;f<d.length;f++)if("*required"===d[f].modelHandler){d=!1;break a}d=!0}d?d=!0:(d=!1,e=!0)}else d=c.isValid(a.proposed,a.options);var f=c.name&&q.errors[c.name],g=a.options,h=v(g)?g.userError:
g,f=c.buildError?c.buildError(f,g):f&&f.contains("{0}")?Ea.apply(null,[f].concat(h.split(","))):h||f||c.error;!d&&(!e||"required"===c.name)?a.addError(f):a.removeError(f);if(!d)a.hasError=!0};if(c.buildOptions)a.buildOptions=c.buildOptions,delete c.buildOptions;return a}function F(c,a){return a?function(a){return!c.test(a)}:function(a){return c.test(a)}}function G(){var c=ia.call(arguments,0);return function(a,b){return b.userError||Ea.apply(null,[a].concat(g.map(c,function(a){return b[a]})))}}function H(c){return c.replace(ba,
"_")}var h=la.via=function(c){return new I(c)},i=g.extend,S={},N=g.isArray,Xa=g.isPlainObject,o=g.isFunction,La=/this\.((?:\.?\w+)+)/g,Ja={undefined:j,"boolean":j,number:j,string:j},l="__via",Ya=/__via\.(\w+)/,Ka=/__via\.(\w+)(\.(.+))*/,m={},q={},k,ma=S[l]={},ca=/_/g,ba=/\./g,z=S.hasOwnProperty,u=Array.prototype,ia=u.slice,s,D=I.prototype={};u.indexOf=u.indexOf||function(c,a){for(var b=a||0;b<this.length;b++)if(this[b]==c)return b;return-1};u.contains=u.contains||function(c){return-1!==this.indexOf(c)};
u.remove=u.remove||function(c){c=this.indexOf(c);-1!=c&&this.splice(c,1);return this};u.pushUnique=u.pushUnique||function(c){this.contains(c)||this.push(c);return this};u.sortObject=u.sortObject||function(c,a){R(a)&&(a=!0);c?this.sort(function(b,d){var e=b[c],f=d[c];return e==f?0:a?e>f?1:-1:e>f?-1:1}):a?this.sort():this.sort().reverse()};var $=String.prototype;$.beginsWith=$.beginsWith||function(c){return 0===this.indexOf(c)};$.contains=$.contains||function(c){return-1!==this.indexOf(c)};i(D,{version:"0.2pre",
constructor:I,pushProxy:function(c){c.oldProxy=this;return c},childProxy:function(c){return this.pushProxy(new I(T(this.context,c)))},parentProxy:function(){return this.pushProxy(new h(h.contextOfPath(this.context)))},popProxy:function(){if(this.oldProxy)return this.oldProxy;throw"invalid operation, proxy.popProxy() failed because oldProxy is empty";},shadowProxy:function(){return this.childProxy("*")},mainProxy:function(){var c;if(this.context===l)c="";else if((c=Ya.exec(this.context))&&c[1])c=c[1].replace(ca,
".");else throw"proxy at '"+this.context+"' is already main proxy";return this.pushProxy(h(c))},triggerChange:function(c){c=this.physicalPath(c);s(c,c,"afterUpdate");return this},logicalPath:function(c){return na(T(this.context,c))},physicalPath:function(c){return r(T(this.context,c))},get:function(c,a){if(n(c)||"number"===typeof c)a=""+c,c=!1;var b=x(this.context,a),d=!b.index?b.hostObj:b.hostObj[b.index];return!c&&o(d)?d.call(b.hostObj):d},call:function(c){var a=x(this.context,c),b=a.hostObj[a.index];
if(!o(b))throw"object at '"+a.logicalPath+"' is not a function";return b.apply(a.hostObj,ia.call(arguments,1))},create:function(c,a,b){if(Xa(c)){for(var d in c)if(z.call(c,d)&&(b=this.create(d,c[d],a),!b))return!1;return this}b=b||x(this.context,c);if(b.index in b.hostObj)throw"value at path: '"+b.logicalPath+"' has been defined, try use update method instead";c=b.physicalPath;if(s(c,c,"beforeCreate",a).hasError)return!1;b.hostObj[b.index]=a;s(c,c,"afterCreate");V(c,a,!0,oa);return this},update:function(c,
a,b){if(""!==this.context&&1===arguments.length)return k.update(this.context,c);b=b||x(this.context,c);if(!(b.index in b.hostObj))throw"value at path: '"+b.logicalPath+"' has been not defined, try use create method instead";var d=b.physicalPath;if(s(d,d,"beforeUpdate",a).hasError)return!1;var e=b.hostObj[b.index];if(e===a)return this;b.hostObj[b.index]=a;s(d,d,"afterUpdate",j,e);V(d,a,!0,oa);return this},del:function(c,a){if(c===j)return k.del(this.context);var b=x(this.context,c);if(!a&&m[c]&&m[c].length)throw"can not remove path "+
c+", because it is referenced!";var d=b.physicalPath;if(!a&&s(d,d,"beforeDel").hasError)return!1;var e=b.hostObj[b.index];V(d,e,!1,function(b,c){k.del(b+"."+c,a)});N(b.hostObj)?b.hostObj.splice(b.index,1):delete b.hostObj[b.index];s(d,d,"afterDel",j,e);for(b=0;b<h.modelCleanups.length;b++)h.modelCleanups[b](d);return this},createOrUpdate:function(c,a){var b=x(this.context,c);return b.index in b.hostObj?this.update(c,a,b):this.create(c,a,b)},createIfUndefined:function(c,a){var b=x(this.context,c);
return b.index in b.hostObj?this:this.create(c,a,b)},updateAll:function(c){var a,b;for(b in c)if(z.call(c,b)&&(a=this.update(b,c[b]),!a))return!1;return this},isModelEmpty:function(c,a){var b=this.get(c,a);return!b?!0:!N(b)?!1:0===b.length},indexOf:function(c){return this.get().indexOf(c)},contains:function(c){return-1!==this.indexOf(c)},first:function(){return this.get("0")},last:function(){var c=this.get();return c[c.length-1]},push:function(c){return this.create(this.get().length,c)},pushRange:function(c){for(var a=
0;a<c.length;a++)this.push(c[a]);return this},pushUnique:function(c){return!this.contains(c)?this.push(c):this},pop:function(){return this.removeAt(this.get().length-1)},insertAt:function(c,a){this.get().splice(c,0,a);s(this.context,this.context+"."+c,"afterCreate");return this},updateAt:function(c,a){return this.update(c,a)},removeAt:function(c){return this.del(c)},prepend:function(c){return this.insertAt(0,c)},swap:function(c,a){if(c==a)return this;var b=this.indexOf(c);if(-1!=b)return this.updateAt(b,
a);throw"oldItem not found";},removeItem:function(c){c=this.indexOf(c);return-1!==c?this.removeAt(c):this},clear:function(){var c=this.get();c.splice(0,c.length);s(this.context,this.context,"init");return this},count:function(){return this.get().length},sort:function(c,a){return h.raiseEvent(this.context,this.context,"init",this.get().sortObject(c,a))}});U.prototype={constructor:U,mainModel:function(){return k.get(this.mainPath)}};i(h,{fn:D,accessor:x,toPhysicalPath:r,toLogicalPath:na,clearObj:function a(b){if(Q(b))return null;
for(var d in b)z.call(b,d)&&(b[d]=a(b[d]));return b},isUndefined:R,isPrimitive:Q,isString:n,isObject:v,shadowNamespace:function(){return l},Shadow:U,modelCleanups:[function(a){for(var b in m)m[b].remove(a),0===m[b].length&&delete m[b];for(var d in m)d.beginsWith(a)&&delete m[d];a.beginsWith(l)||k.del(l+"."+a.replace(ba,"_"))}],addRef:function(a,b){a=r(a);b=r(b);m[b]=m[b]||[];m[b].pushUnique(a);return this},removeRef:function(a,b){a=r(a);b=r(b);m[b].remove(a);m[b].length||delete m[b];return this},
modelReferences:m,options:function(a,b){if(a===j)return q;if(v(a))return i(q,a),a;if(1===arguments.length)return q[a];if(b===j)delete q[a];else return q[a]=b},pureModel:function(a,b){var d=i({},k.get(!0,a));delete d[l];d=JSON.stringify(d);return b?d:JSON.parse(d)},empty:function(){for(var a in S)a!==l&&k.del(a,!0)}});k=new I("");var Ma=/(\w+)?(\*?)(\.?)([^\s]*)/,Za=/^(.+)\.\w+$/,$a=/^.+\.(\w+)$|\w+/,ea={},B=la.RegExp,p={},w={},ra=/\s*\|\s*/,Na=/^\w+(?!\w*\.\w+)/,ab=/^(\w+)\.?/,A=g.fn;s=function(a,
b,d,e,f){a=new C(a,b,d,e,f);pa(a);if(a.continueEventing&&a.bubbleUp)for(a.eventType=ab.exec(a.eventType)[1]+".child";((b=h.contextOfPath(a.path))||1)&&!(a.path=b,pa(a),!a.continueEventing||!a.bubbleUp||""===b););return a};C.prototype={constructor:C,targetProxy:function(){return h(this.target)},targetValue:function(a){return h().get(a,this.target)},targetContext:function(){return h.contextOfPath(this.target)},targetIndex:function(){return h.indexOfPath(this.target)},bubbleUp:!0,continueEventing:!0,
hasError:!1,currentValue:function(a){return h().get(a,this.path)},currentProxy:function(){return h(this.path)},isModelEmpty:function(){var a=this.options,a=a?n(a)?"true"===a:!!a:!1;return this.currentProxy().isModelEmpty(a)}};fa(ea);i(h,{addModelHandler:function(a,b,d,e,f){if("once"===b)return this.renderViews(a,d,e,f);if(n(d)||o(d))f=e,e=d,d=ea;"_"===f&&(f=j);a=r(a,!0);d=g(d);0<d.length&&!p[a]&&(p[a]=[]);d.each(function(){f=sa(this,e,f);fa(this);p[a].push({view:this,modelHandler:e,modelEvents:b,
options:f});qa(b,"init")&&da(this,e,new C({path:a,target:a,eventType:"init",options:f}))});return h},removeModelHandler:function(a){if(n(a)){var a=r(a),b;for(b in p)b.beginsWith(a)&&delete p[b]}else v(a)&&g(a).each(function(a,b){if(W(b))for(var f in p){for(var g=p[f],h=g.length-1;0<=h;h--)g[h].view===b&&g.splice(h,1);0===g.length&&delete p[f]}});return h},getModelHandlerData:function(a){if(n(a))return p[r(a)];if(v(a)){if(!W(a))return;var b,d;for(d in p)for(var e=p[d],f=e.length-1;0<=f;f--)e[f].view===
a&&(b=b||{},b[d]=b[d]||[],b[d].push(e[f]));return b}if(!a)return p},renderViews:function(a,b,d,e){a=r(a,!0);g(b).each(function(){e=sa(this,d,e);da(this,d,new C({path:a,target:a,eventType:"init",options:e}))});return h},ModelEvent:C,commonModelHandlers:w,raiseEvent:s,indexOfPath:function(a){a=$a.exec(a);return a[1]||a[0]},contextOfPath:function(a){return(a=Za.exec(a))&&a[1]||""}});h.modelCleanups.push(h.removeModelHandler);A.addModelHandler=function(a,b,d,e){h.addModelHandler(a,b,this,d,e);return this};
A.renderViews=function(a,b,d){h.renderViews(a,this,b,d);return this};var K={},ga={},t={};J.prototype={constructor:J,targetProxy:function(){return h(this.path)},targetValue:function(a){return k.get(a,this.path)},targetContext:function(){return h.contextOfPath(this.path)},targetIndex:function(){return h.indexOfPath(this.path)},updateModel:function(a){return k.update(this.path,a)},returnFalse:function(){this.e.stopPropagation();this.e.preventDefault()},stopPropagation:function(){this.e.stopPropagation()},
stopImmediatePropagation:function(){this.e.stopImmediatePropagation()}};i(h,{addViewHandler:function(a,b,d,e,f){var d=r(d,!0),i=e;"_"===f&&(f=j);n(e)&&e.beginsWith("*")&&(e=K[e.substring(1)]);o(e.buildOptions)&&(f=e.buildOptions(a,f));o(e.initialize)&&e.initialize(a);b=g.map(b.split(ra),function(a){return a+"."+l+"."+d}).join(" ");g(a).each(function(){fa(this);g(this).bind(b,{viewHandler:e,path:d,options:f,originalHandler:i},Oa);t[d]=t[d]||[];t[d].pushUnique(this)});return h},removeViewHandler:function(a){n(a)?
(a=r(a),g(t[a]).unbind("."+l+"."+a),delete t[a]):v(a)&&(g(a).unbind("."+l),g(a).each(function(){for(var a in t)t[a].remove(this)}));return h},removeView:function(a){g(a).each(function(a,d){W(this)&&(h.removeModelHandler(d).removeViewHandler(d),g(this).removeData(l))});return h},commonViewHandlers:K,valueConverters:ga,ViewEvent:J,getViewHandlerData:function(a){if(n(a))return t[a];if(v(a)){if(!W(a))return;var b=[],d;for(d in t)z.call(t,d)&&t[d].contains(a)&&b.push(d);return b}if(!a)return t},getHandlerData:function(a){var b=
h.getModelHandlerData(a),d=h.getViewHandlerData(a);if(n(a)){for(var e,a=0;a<b.length;a++)e=e||[],e.pushUnique(b[a].view);return{viewsToBeUpdated:e,viewsUpdatingMe:d}}var f,g;for(g in b)f=f||[],f.pushUnique(g);return{pathsUpdatingMe:f,pathsToBeUpdated:d}}});h.modelCleanups.push(h.removeViewHandler);var bb=g.cleanData;g.cleanData=function(a){h.removeView(a);bb(a)};h.forwardEvent=function(a,b,d){var e=function(a){d(a)&&g(a.target).trigger(i({},a,{type:b,currentTarget:a.target}))};if(g.event.special[b])throw"event '"+
b+"' has been defined";g.event.special[b]={setup:function(){g(this).bind(a,e)},teardown:function(){g(this).unbind(a,e)}};return h};h.addViaEvent=function(a,b){g.event.special[a]={setup:function(){g(this).bind(b,a,ta)},teardown:function(){g(this).unbind(b,ta)}};return h};A.addViewHandler=function(a,b,d,e){h.addViewHandler(this,a,b,d,e);return this};var ja=/^[\.\*]\w+/,Ga=/^\.([\.\*])/,Ta=/\s+/g,Pa=/\s*@(\w+)(:([^@]+))*/g,Ra=/\s*;\s*/g,Sa=/(.+?)(,(.+?))?(,(.+))*$/,Ua=/(.+?),(.+?),(.+?)(,(.+))*$/,M=
"class",Va="mh,vh,class,theme,path,options".split(","),L={},aa={},y,O;q.theme="via";var xa=h.mergePath=function(a,b){if(!b||"."==b)return a;if(Ga.test(b))return b.replace(Ga,h.contextOfPath(a)+"$1");if(ja.test(b)){var d=/^(.+)\*/.exec(a);return d&&d[1]&&b.beginsWith("*")?d[1]+b:b.replace(ja,a+"$&")}return b};i(h,{specialParsers:y={},classMatchers:aa,view:function(a){return g(a||":via").each(function(){if(!g(this).data("via")){var a;if(a=g(this).attr("via")){a=ua(a);g(this).data("via",a);if(a.path&&
"."!==a.path){if(ja.exec(a.path))a.path=za(this)+a.path}else a.path=za(this);a.theme=a.theme||q.theme;var d={mh:[],vh:[]},e=a,f=M,i;if(!(i=a[M]))b:{for(var j in aa)if(z.call(aa,j)&&aa[j](this)){i=j;break b}i=void 0}e[f]=i;wa(this,a,d);e=a;Y("mh",this,e,d);Y("vh",this,e,d);ya(this,a,d);a=d}else a=void 0;if(a){d=a.mh;e=a.vh;for(a=0;a<d.length;a++)f=d[a],h.addModelHandler(f.path,f.modelEvents,f.view,f.modelHandler,f.options);for(a=0;a<e.length;a++)d=e[a],h.addViewHandler(d.view,d.viewEvents,d.path,d.viewHandler,
d.options)}}})},themes:{via:{subThemes:j,bindingSet:O={}}}});y.viaEvent=function(a,b,d,e){if(!b.viewEvents)b.viewEvents={};a=e.split(",");for(d=0;d<a.length;d++)e=a[d].split("."),b.viewEvents[e[0]]=e[1]};g.expr[":"].via=function(a){return!!g(a).attr("via")};A.view=function(){h.view(this.findAll(":via"));return this};g.fn.findAll=g.fn.findAll||function(a){if(0===this.length)return this;var b=this.filter(a);this.each(function(){b=b.add(g(this).find(a))});return b};g.fn.renderTemplate=function(a,b,d,
e,f){return this.each(function(){function h(b){a&&(g(j)[a](b),b.view());k&&k.call(j,b)}var i,j=this,k=e&&(g.isFunction(e)?e:e.callback);"object"===typeof e?(e.callback=h,i=e):i=h;Aa(j,b,d,i,f)})};h.compileTemplate=function(a,b,d){d=d||q.engine;if(!d)throw"there is not default engine registered";d=E[d];if(!d)throw"engine '"+d+"' can not be found.";return d.compileTemplate(a,b)};Ca.buildOptions=ha.buildOptions=function(a){return n(a)?(a=a.split(","),{templateId:g.trim(a[0]),engineName:a[1]}):a};i(w,
{template:ha,templateOne:Ca});var E=h.templateEngines={};if(g.tmpl)q.engine="tmpl",E.tmpl={renderTemplate:function(a,b,d){return a.beginsWith("#")?g(a).tmpl(b,d):g.tmpl(a,b,d)},compileTemplate:function(a,b){g.template(a,b)},isTemplateCompiled:function(a){return a.beginsWith("#")?!!g(a).length:!!g.template[a]}};else if(g.render)q.engine="jsrender",E.jsrender={renderTemplate:function(a,b,d){return a.beginsWith("#")?g(a).render(b,d):g.render(b,a,d)},compileTemplate:function(a,b){g.template(a,b)},isTemplateCompiled:function(a){return a.beginsWith("#")?
!!g(a).length:!!g.views.templates[a]}};E.tmpl&&h.compileTemplate("ddl_tmpl","<option value='${this.value($data)}'>${this.name($data)}</option>");E.jsrender&&h.compileTemplate("ddl_jsrender","<option value='{{=$ctx.value($data)}}'>{{=$ctx.name($data)}}</option>","jsrender");i(w,{dropdown:i(function(a){w.template.call(this,a)},{buildOptions:function(a){var b=(a||"").split(","),a=1===b.length?{name:function(a){return a.toString()},value:function(a){return a.toString()},engine:a}:{name:function(a){return a[b[0]]},
value:function(a){return a[b[1]]},engine:b[2]};a.templateId="ddl_"+(a.engine||q.engine);return a}}),pushViewItem:function(a){g(this).renderTemplate("append",a.options,a.targetValue())},removeViewItem:function(a){g(this).children().eq(+a.targetIndex()).remove()},updateViewItem:function(a){g(this).children().eq(a.targetIndex()).renderTemplate("replaceWith",a.options,a.targetValue())},showIfTruthy:function(a){g(this)[a.isModelEmpty()?"hide":"show"]()},showIfFalsy:function(a){g(this)[a.isModelEmpty()?
"show":"hide"]()},enableIfTruthy:function(a){g(this).attr("disabled",a.isModelEmpty())},enableIfFalsy:function(a){g(this).attr("disabled",!a.isModelEmpty())},val:function(a){a=a.currentValue();a!==g(this).val()&&g(this).val(a)}});i(K,{value:function(a){return o(a.options)?a.options():a.options},evalOptions:function(a){return eval(a.options)},stringOptions:function(a){return a.options},numberOptions:function(a){return+a.options},trueValue:function(){return!0},falseValue:function(){return!1},toggle:function(a){return!a.targetValue()},
trueIfCheck:function(){return this.checked},trueIfUncheck:function(){return!this.checked},returnFalse:function(a){a.returnFalse()},preventDefault:function(a){a.e.preventDefault()},stopBubble:function(a){a.e.stopImmediatePropagation()}});i(ga,{toNumber:function(a){return+a},toDate:function(a){return new Date(a)},toString:function(a){return null===a||a===j?"":""+a}});O.simpleList="@mh:.,init|afterUpdate,*template;.,afterCreate.child,*pushViewItem;.,afterUpdate.child,*updateViewItem;.,afterDel.child,*removeViewItem,_";
y.lookup=function(a,b,d,e){var e=/^(.+?)(,(.*))*$/.exec(e),f=b.path;d.mh.push({path:h.mergePath(b.path,e[1]),modelEvents:"init",view:a,modelHandler:"*dropdown",options:e[3]});f&&(d.mh.push({path:b.path,modelEvents:"afterUpdate",view:a,modelHandler:"*val"}),d.vh.push({path:b.path,viewEvents:"change",view:a,viewHandler:"$val"}))};h.classMatchers.textBox=function(a){return g(a).is(":text")};i(O,{textBox:"@mh:.,init|after*,*val@vh:.,keyup,$val",label:"@mh:.,init|after*,$html"});q.errors={required:"This field is required.",
email:"Please enter a valid email address.",url:"Please enter a valid URL.",date:"Please enter a valid date.",dateISO:"Please enter a valid date (ISO).",number:"Please enter a valid number.",digits:"Please enter only digits.",creditcard:"Please enter a valid credit card number.",equal:"Please enter the same value again.",accept:"Please enter a value with a valid extension.",maxlength:"Please enter no more than {0} characters.",minlength:"Please enter at least {0} characters.",rangelength:"Please enter a value between {0} and {1} characters long.",
range:"Please enter a value between {0} and {1}.",max:"Please enter a value less than or equal to {0}.",min:"Please enter a value greater than or equal to {0}."};var Z=ma.invalidModelPaths=[],ka=h("*invalidModelPaths"),Wa=/^\s*$/,Ha=/^\d+$/,cb=/^(\/(\\[^\x00-\x1f]|\[(\\[^\x00-\x1f]|[^\x00-\x1f\\\/])*\]|[^\x00-\x1f\\\/\[])+\/[gim]*)(,(.*))$/,P=/(\w+)(,(.*))?/,Ia=/(\w+),(\w+)(,(.*))?/;D.isValid=function(){var a=this.context+"*invalidated";if(k.get(a))return Da(this.context);k.create(a,!0);for(var b in p)if(b.beginsWith(this.context))for(var a=
p[b],d=0;d<a.length;d++){var e=a[d];if("beforeUpdate"===e.modelEvents){s({path:b,eventType:e.modelEvents,target:b,proposed:h().get(b)});s({path:b,eventType:"init",target:b});break}}return Da(this.context)};i(h.ModelEvent.prototype,{addError:function(a){this.currentProxy().createIfUndefined("*errors",[]).childProxy("*errors").pushUnique(a);ka.pushUnique(this.path)},removeError:function(a){this.currentProxy().createIfUndefined("*errors",[]).childProxy("*errors").removeItem(a).isModelEmpty()&&ka.removeItem(this.path)}});
h.addValidator=function(a){if(N(a))for(var b=0;b<a.length;b++)h.addValidator(a[b]);else{w[a.name]=Fa(a);if(a.name&&a.error)q.errors[a.name]=a.error;y[a.name]=function(b,e,f){f.mh.push({path:e.path,modelEvents:"beforeUpdate",view:b,modelHandler:"*"+a.name,options:!0===e[a.name]?j:e[a.name]})}}};h.addValidator([{name:"required",isValid:function(){return!0}},{name:"email",isValid:F(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i)},
{name:"url",isValid:F(/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i)},
{name:"date",isValid:F(/Invalid|NaN/,!0)},{name:"dateISO",isValid:F(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/)},{name:"number",isValid:F(/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/)},{name:"digits",isValid:F(Ha)},{name:"creditcard",isValid:function(a){if(/[^0-9\-]+/.test(a))return!1;for(var b=0,d=0,e=!1,a=a.replace(/\D/g,""),f=a.length-1;0<=f;f--){d=a.charAt(f);d=parseInt(d,10);if(e&&9<(d*=2))d-=9;b+=d;e=!e}return 0===b%10}},{name:"minlength",isValid:function(a,b){return a.length>=b.minlength},buildOptions:function(a){var b;
if(a&&(b=P.exec(a)))return{minlength:+b[1],userError:b[3]};throw"invalid options for minlength validator";},buildError:G("minlength")},{name:"maxlength",isValid:function(a,b){return a.length<=b.maxlength},buildOptions:function(a){var b;if(a&&(b=P.exec(a)))return{maxlength:+b[1],userError:b[3]};throw"invalid options for maxlength validator";},buildError:G("maxlength")},{name:"rangelength",isValid:function(a,b){return a.length>=b.minlength&&a.length<=b.maxlength},buildOptions:function(a){var b;if(a&&
(b=Ia.exec(a)))return{minlength:+b[1],maxlength:+b[2],userError:b[4]};throw"invalid options for rangelength validator";},buildError:G("minlength","maxlength")},{name:"min",isValid:function(a,b){return a>=b.min},buildOptions:function(a){var b;if(a&&(b=P.exec(a)))return{min:+b[1],userError:b[3]};throw"invalid options for min validator";},buildError:G("min")},{name:"max",isValid:function(a,b){return a<=b.max},buildOptions:function(a){var b;if(a&&(b=P.exec(a)))return{max:+b[1],userError:b[3]};throw"invalid options for max validator";
},buildError:G("max")},{name:"range",isValid:function(a,b){return a>=b.min&&a<=b.max},buildOptions:function(a){var b;if(a&&(b=Ia.exec(a)))return{min:+b[1],max:+b[2],userError:b[4]};throw"invalid options for range validator";},buildError:G("min","max")},{name:"equal",isValid:function(a,b){return k.get(b.path)===a},buildOptions:function(a){var b;if(a&&(b=P.exec(a)))return{path:b[1],userError:b[3]};throw"invalid options for equal validator";}},{name:"regex",isValid:function(a,b){return b.regex.test(a)},
buildOptions:function(a){var b;if(a&&(b=cb.exec(a)))return{regex:eval(b[1]),userError:b[5]};throw"invalid options for regex validator";}}]);h.validate=function(a,b,d){return n(b)?h.addModelHandler(a,"beforeUpdate","*"+b,d):h.addModelHandler(a,"beforeUpdate",Fa(b))};h.modelCleanups.push(function(a){ka.removeItem(a)});w.inlineError=function(a){a.isModelEmpty()?g(this).removeClass("error").next("span.error").remove():g(this).addClass("error").next("span.error").remove().end().after("<span class='error'>"+
a.currentValue()+"</span>")};y.inlineError=function(a,b,d){d.mh.push({path:b.path+"*errors",modelEvents:"after*",view:a,modelHandler:"*inlineError"})};i(D,{enableQuery:function(a){var b={query:{page:{enabled:!1,index:0,count:1,size:0},sort:{by:null,asc:null},filter:{filterBuilder:function(){if(this.ops&&this.by&&this.value)return b.query.filter.defaultFilter},defaultFilter:function(){var a=b.query.filter,e=a.by,f=a.value;switch(a.ops){case "equals":return B("^"+f+"$","i").test(this[e]);case "contains":return B(f,
"i").test(this[e])}return!0},by:"",value:"",ops:"",enabled:function(){return!!this.filterBuilder()}},enabled:function(){var a=this.sort;return!!this.page.enabled||!!a.by||!!this.filter.enabled()}},queryResult:function(a){var b=g(this.mainModel()),f=this.query,i=f.filter.filterBuilder(),b=i?b.filter(i).get():b.get();h().update(this.mainPath+"*hasResult",0<b.length);f.sort.by&&b.sortObject(f.sort.by,f.sort.asc);f=f.page;if(!a&&f.enabled){a=Math.ceil(b.length/f.size)||1;if(a!=f.count){f.count=a;if(f.index>
f.count-1)f.index=0;h(this.mainPath+"*query.page").triggerChange()}b=b.slice(f.index*f.size,(f.index+1)*f.size)}return b},hasResult:!1};this.shadowProxy().create(b);h.addRef(this.context+"*queryResult",this.context);a||h.removeRef(this.context+"*queryResult",this.context+"*query");return this},notifyQueryChange:function(){return this.triggerChange("*queryResult")},enableSorter:function(){this.shadowProxy().create("sort",{by:"",asc:!0});h.addModelHandler(this.context+"*sort","after*",function(a){var b=
a.currentValue();b.by&&a.currentProxy().mainProxy().sort(b.by,b.asc)})},setPageIndex:function(a){a instanceof J&&(a=g(a.e.target).attr("page"));var b=this.get("*query.page");if(Ha.test(a))a=+a;else if("next"==a)a=b.index+1;else if("previous"==a)a=b.index-1;else if("first"==a)a=0;else if("last"==a)a=b.count-1;else if("disabled"==a)return this.update("*query.page.enabled",!1);if("number"!==typeof a||0>a||a>b.count-1)a=0;return this.update("*query.page.index",a)},disableFilter:function(){this.childProxy("*query.filter").update("by",
"").update("value","").update("ops","");return this},disablePage:function(){var a=this.get("*query.page");a.size=0;a.count=1;a.index=0;a.enabled=!1;this.triggerChange("*query.page");return this},disableSort:function(){this.childProxy("*query.sort").update("by",null).update("asc",null);return this},clearQuery:function(){return this.disablePage().disableSort().disableFilter()}});i(O,{sortQuery:"@vh:*query.sort.by,click,*stringOptions;*query.sort.asc,click,*toggle,_;.,click,p.notifyQueryChange,_",resetQuerySort:"@mh:*query.sort.by,init|afterUpdate,*showIfTruthy ;@vh:.,click,p.clearQuery;.,click,p.notifyQueryChange",
queryPager:"@mh:*query.page,init|after*,*template;*hasResult,init|after*,*showIfTruthy,_",enablePaging:"@mh:*query.page.size,init|afterUpdate,*enableIfTruthy@vh:*query.page.enabled,click,*trueValue;.,click,p.notifyQueryChange",sortModel:"@vh:*sort.by,click,*stringOptions;*sort.asc,click,*toggle,_;.,click,"});h.editMode={none:0,create:1,update:2};h.ViewEvent.prototype.selectedIndex=function(){return g(this.e.currentTarget).children().filter(g(this.e.target).parents()).index()};i(D,{enableListEdit:function(a){return this.shadowProxy().create({edit:{mode:0,
item:null,selectedIndex:-1,newItem:a}}).popProxy()}});i(K,{newDataItem:function(a){var b;a.options?b=i({},a.options):(b=k.get(a.path+"*edit.newItem"))?b=i({},b):(b=a.targetProxy().get(0))&&(b=h.clearObj(i({},b)));if(!b)throw"can not find create a new item";a.targetProxy().update("*edit.item",b)},insertDataItem:function(a){a=a.targetProxy();a.push(a.get("*edit.item")).update("*edit.item",null).update("*edit.mode",h.editMode.none)},cancelNewDataItem:function(a){a.targetProxy().update("*edit.item",null).update("*edit.mode",
h.editMode.none)},removeItem:function(a){var b=a.targetProxy();b.childProxy("*edit").update("selectedIndex",-1).update("mode",h.editMode.none);var d=b.get("*queryResult")||b.get();b.removeItem(d[a.selectedIndex()])},updateItem:function(a){var b=a.selectedIndex(),a=a.targetProxy(),d=a.childProxy("*edit"),e=a.get("*queryResult")||a.get();a.swap(e[b],d.get("item"));d.update("item",null).update("mode",h.editMode.none).update("selectedIndex",-1)},cancelEditItem:function(a){a.selectedIndex();a.targetProxy().childProxy("*edit").update("item",
null).update("mode",h.editMode.none).update("selectedIndex",-1)},editItem:function(a){var b=a.selectedIndex(),d=a.targetProxy(),a=d.childProxy("*edit"),d=d.get("*queryResult")||d.get();a.get("mode")!==h.editMode.none&&a.update("item",null).update("mode",h.editMode.none).update("selectedIndex",-1);a.update("item",g.extend({},d[b])).update("selectedIndex",b).update("mode",h.editMode.update)}});i(w,{renderNewItem:function(a){if(1===a.targetValue()){var b=a.targetProxy().mainProxy().get("*edit.item");
g(this).renderTemplate("html",a.options,b)}else g(this).empty()},renderEditItem:function(a){var b=a.currentValue(),d=a.targetProxy().mainProxy();-1!==b&&g(this).children().eq(b).renderTemplate("replaceWith",a.options,d.get("*edit.item"))},renderReadItem:function(a){if(-1===a.currentValue()){var b=a.targetProxy().mainProxy();g(this).children().eq(a.removed).renderTemplate("replaceWith",a.options,(b.get("*queryResult")||b.get())[a.removed])}}});h.addViaEvent("action","click");y.editableList=function(a,
b,d,e){var f=e.split(","),e=g.trim(f[0]),h=g.trim(f[1]),f=f[2],b=b.path;d.mh.push({path:b+"*edit.selectedIndex",modelEvents:"afterUpdate",view:a,modelHandler:"*renderReadItem",options:f?e+","+f:e},{path:b+"*edit.selectedIndex",modelEvents:"afterUpdate",view:a,modelHandler:"*renderEditItem",options:f?h+","+f:h});d.vh.push({path:b,viewEvents:"action.edit",view:a,viewHandler:"*editItem"},{path:b,viewEvents:"action.remove",view:a,viewHandler:"*removeItem"},{path:b,viewEvents:"action.update",view:a,viewHandler:"*updateItem"},
{path:b,viewEvents:"action.cancelEdit",view:a,viewHandler:"*cancelEditItem"})};i(O,{newItemButton:"@vh:.,click,*newDataItem;*edit.mode,click,*numberOptions,1;*edit.selectedIndex,*numberOptions,-1@mh:*edit.mode,init|afterUpdate,*showIfFalsy",newItemForm:"@mh:.mode,init|afterUpdate,*renderNewItem",renderEditItem:"@mh:*edit.selectedIndex,afterUpdate,*renderEditItem"});y.app=function(a,b,d,e){var f=H(g.trim(e));h.downloadApp(f).done(function(){h.getApp(f).load(a)})};k.create("*appStore",{});h.downloadApp=
function(a){return h.getApp(a)?g.Deferred().resolve().promise():matrix(H(a)+".app")};h.addApp=function(a,b){a=H(a);return h.getApp(a)?this:k.create("*appStore."+H(a),b)};h.removeApp=function(a){if(h.getApp(a))return a=H(a),matrix.release(a+".app"),k.del("*appStore."+a)};h.getApp=function(a){return k.get("*appStore."+H(a))}}(jQuery,window);
