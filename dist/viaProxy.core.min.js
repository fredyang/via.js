/*!
 * viaProxy.js JavaScript Library 0.2pre
 * http://semanticsworks.com
 *
 * Copyright 2011, Fred Yang
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/gpl-2.0
 *
 * Date: Wed Dec 21 22:32:20 2011 -0500
 */
 window.jQuery&&window.via||function(h,S,k){function x(c){this.context=o(c||"",!0)}function u(c){return"object"===typeof c}function p(c){return"string"===typeof c}function B(c){return null===c||typeof c in ca}function C(c){return c===k}function v(c,a){0===a&&(a="0");var b,d,e=D,g=E(c,a),f=o(g,!0),h=f.split(".");if(1===h.length)d=f;else{d=h[h.length-1];for(b=0;b<h.length-1&&!(e=e[h[b]],e===k);b++);}if(B(e))throw"invalid access proxy using path:"+g;return{physicalPath:f,logicalPath:g,hostObj:e,index:d}}
function F(c){this.mainPath=c}function o(c,a){if(!c)return"";if("*"===c)return j;var b=c.split("*");if(1===b.length)return c;var d=b[0],b=b[1],e=d.replace(T,"_");if(a&&d){var g=j+"."+e;!da[e]&&m.get(d)!==k&&m.create(g,new F(d))}return!e?j+"."+b:b?j+"."+e+"."+b:j+"."+e}function U(c){if(c===j)return"*";var a=ea.exec(c);return a&&a[1]?a[2]?a[1].replace(K,".")+"*"+a[3]:a[1].replace(K,".")+"*":c}function G(c,a,b,d){var e,g=c.lastIndexOf(".");b&&(-1===g?(b="",e=c):(b=c.substring(0,g),e=c.substring(g+1)),
d(b,e,a));if(!B(a))for(e in a)y.call(a,e)&&(d(c,e,a[e]),G(c+"."+e,a[e],!1,d))}function V(c,a,b){if(n(b))for(var b=b.toString(),d,e,g,f;(d=fa.exec(b))&&(e=d[1]);)c?(g=c+"."+a,f=c+"."+e):(g=a,f=e),i[f]=i[f]||[],i[f].pushUnique(g)}function E(c,a){return!a?c:c?c+(a.toString().beginsWith("*")?a:"."+a):a}function W(c){var a,b,d=q[c.path];if(d)for(b=0;b<d.length;b++){a=d[b];if(X(a.modelEvents,c.eventType))c.options=a.options,L(a.view,a.modelHandler,c);if(!c.continueEventing)return}if((a=i[c.path])&&a.length)for(d=
0;d<a.length;d++){b=r(a[d],a[d],c.eventType,c.proposed===k?k:m.get(!0,a[d]));if(!b.continueEventing)break;if(b.hasError)c.hasError=!0}}function L(c,a,b){c===M&&(c=null);if(n(a))return a.call(c,b);if(p(a)){var d=a.substring(1),e=a.substring(2);if(a.beginsWith("*")){if(d=N[d])return d.call(c,b)}else if(a.beginsWith("$")){if(n(z[d])){a=b.currentValue();if("css,attr,prop".contains(d))b=b.options||b.targetIndex(),h(c)[d](b,a);else h(c)[d](a&&a.toString());return}}else if(a.beginsWith("v.")&&c[e]){a=b.currentValue();
if(n(c[e]))c[e](a);else c[e]=a;return}}throw"handler: "+a+" not found";}function X(c,a){var b;if("*"===c)return!0;for(var c=c.split(Y),d=0;d<c.length;d++){b=c[d];if(b===a)return!0;if(b=ga.exec(b))if(b[4])if(b[1]){if(O("^"+b[1]+"\\w*\\."+b[4]).test(a))return!0}else{if(O("^\\w+\\."+b[4]).test(a))return!0}else if(b[3]){if(b=b[1]?O("^"+b[1]+"(?!\\w*\\.\\w+)"):ha,b.test(a))return!0}else if(a.beginsWith(b[1]))return!0}return!1}function w(c,a,b,d,e){u(c)?t(this,c):(this.path=c,this.target=a,this.eventType=
b,!C(d)&&(this.proposed=d),!C(e)&&(this.removed=e))}function Z(c,a,b){p(a)&&a.beginsWith("*")&&(a=N[a.substring(1)]);n(a.buildOptions)&&(b=a.buildOptions.call(c,b));return b}function P(c){h(c).data(j,!0)}function H(c){return!0===h(c).data(j)}function I(c,a,b,d){u(c)?t(this,c):(this.path=c,this.options=a,this.e=b,this.triggerData=d)}function ia(c,a){var b=c.data,d=new I(b.path,b.options,c,a),b=b.viewHandler;if(n(b))return J(d,b.call(this,d));if(p(b)){var e=b.substring(1),g=b.substring(2);if(b.beginsWith("*")){if(e=
Q[e]){e.call(this,d);return}}else if(b.beginsWith("$")){if(n(z[e]))return J(d,"css,attr,prop".contains(e)?h(this)[e](d.options||d.targetIndex()):h(this)[e]())}else if(b.beginsWith("p.")){if(n(R[g])){d.targetProxy()[g](d);return}}else if(b.beginsWith("v.")){if(e=this[g],n(e))return J(d,e.call(this,d))}else if(b.beginsWith("m.")&&(e=m.get(!0,g),n(e)))return J(d,e.call(this,d))}throw"view handler: '"+b+"' not found";}function J(c,a){if(a!==k){var b=c.options;p(b)&&b.beginsWith("*")&&(b=$[b.substring(1)])&&
(a=b(a));m.update(c.path,a)}}function aa(c){var a=c.data,b=h(c.target).data("via");(b=b&&b.viewEvents&&b.viewEvents[a])&&h(c.target).trigger(t({},c,{type:a+"."+b,currentTarget:c.target}))}var f=S.via=function(c){return new x(c)},t=h.extend,D={},ba=h.isArray,ja=h.isPlainObject,n=h.isFunction,fa=/this\.((?:\.?\w+)+)/g,ca={undefined:k,"boolean":k,number:k,string:k},j="__via",ka=/__via\.(\w+)/,ea=/__via\.(\w+)(\.(.+))*/,i={},A={},m,da=D[j]={},K=/_/g,T=/\./g,y=D.hasOwnProperty,l=Array.prototype,la=l.slice,
r,R=x.prototype={};l.indexOf=l.indexOf||function(c,a){for(var b=a||0;b<this.length;b++)if(this[b]==c)return b;return-1};l.contains=l.contains||function(c){return-1!==this.indexOf(c)};l.remove=l.remove||function(c){c=this.indexOf(c);-1!=c&&this.splice(c,1);return this};l.pushUnique=l.pushUnique||function(c){this.contains(c)||this.push(c);return this};l.sortObject=l.sortObject||function(c,a){C(a)&&(a=!0);c?this.sort(function(b,d){var e=b[c],g=d[c];return e==g?0:a?e>g?1:-1:e>g?-1:1}):a?this.sort():this.sort().reverse()};
l=String.prototype;l.beginsWith=l.beginsWith||function(c){return 0===this.indexOf(c)};l.contains=l.contains||function(c){return-1!==this.indexOf(c)};t(R,{version:"0.2pre",constructor:x,pushProxy:function(c){c.oldProxy=this;return c},childProxy:function(c){return this.pushProxy(new x(E(this.context,c)))},parentProxy:function(){return this.pushProxy(new f(f.contextOfPath(this.context)))},popProxy:function(){if(this.oldProxy)return this.oldProxy;throw"invalid operation, proxy.popProxy() failed because oldProxy is empty";
},shadowProxy:function(){return this.childProxy("*")},mainProxy:function(){var c;if(this.context===j)c="";else if((c=ka.exec(this.context))&&c[1])c=c[1].replace(K,".");else throw"proxy at '"+this.context+"' is already main proxy";return this.pushProxy(f(c))},triggerChange:function(c){c=this.physicalPath(c);r(c,c,"afterUpdate");return this},logicalPath:function(c){return U(E(this.context,c))},physicalPath:function(c){return o(E(this.context,c))},get:function(c,a){if(p(c)||"number"===typeof c)a=""+
c,c=!1;var b=v(this.context,a),d=!b.index?b.hostObj:b.hostObj[b.index];return!c&&n(d)?d.call(b.hostObj):d},call:function(c){var a=v(this.context,c),b=a.hostObj[a.index];if(!n(b))throw"object at '"+a.logicalPath+"' is not a function";return b.apply(a.hostObj,la.call(arguments,1))},create:function(c,a,b){if(ja(c)){for(var d in c)if(y.call(c,d)&&(b=this.create(d,c[d],a),!b))return!1;return this}b=b||v(this.context,c);if(b.index in b.hostObj)throw"value at path: '"+b.logicalPath+"' has been defined, try use update method instead";
c=b.physicalPath;if(r(c,c,"beforeCreate",a).hasError)return!1;b.hostObj[b.index]=a;r(c,c,"afterCreate");G(c,a,!0,V);return this},update:function(c,a,b){if(""!==this.context&&1===arguments.length)return m.update(this.context,c);b=b||v(this.context,c);if(!(b.index in b.hostObj))throw"value at path: '"+b.logicalPath+"' has been not defined, try use create method instead";var d=b.physicalPath;if(r(d,d,"beforeUpdate",a).hasError)return!1;var e=b.hostObj[b.index];if(e===a)return this;b.hostObj[b.index]=
a;r(d,d,"afterUpdate",k,e);G(d,a,!0,V);return this},del:function(c,a){if(c===k)return m.del(this.context);var b=v(this.context,c);if(!a&&i[c]&&i[c].length)throw"can not remove path "+c+", because it is referenced!";var d=b.physicalPath;if(!a&&r(d,d,"beforeDel").hasError)return!1;var e=b.hostObj[b.index];G(d,e,!1,function(b,c){m.del(b+"."+c,a)});ba(b.hostObj)?b.hostObj.splice(b.index,1):delete b.hostObj[b.index];r(d,d,"afterDel",k,e);for(b=0;b<f.modelCleanups.length;b++)f.modelCleanups[b](d);return this},
createOrUpdate:function(c,a){var b=v(this.context,c);return b.index in b.hostObj?this.update(c,a,b):this.create(c,a,b)},createIfUndefined:function(c,a){var b=v(this.context,c);return b.index in b.hostObj?this:this.create(c,a,b)},updateAll:function(c){var a,b;for(b in c)if(y.call(c,b)&&(a=this.update(b,c[b]),!a))return!1;return this},isModelEmpty:function(c,a){var b=this.get(c,a);return!b?!0:!ba(b)?!1:0===b.length},indexOf:function(c){return this.get().indexOf(c)},contains:function(c){return-1!==this.indexOf(c)},
first:function(){return this.get("0")},last:function(){var c=this.get();return c[c.length-1]},push:function(c){return this.create(this.get().length,c)},pushRange:function(c){for(var a=0;a<c.length;a++)this.push(c[a]);return this},pushUnique:function(c){return!this.contains(c)?this.push(c):this},pop:function(){return this.removeAt(this.get().length-1)},insertAt:function(c,a){this.get().splice(c,0,a);r(this.context,this.context+"."+c,"afterCreate");return this},updateAt:function(c,a){return this.update(c,
a)},removeAt:function(c){return this.del(c)},prepend:function(c){return this.insertAt(0,c)},swap:function(c,a){if(c==a)return this;var b=this.indexOf(c);if(-1!=b)return this.updateAt(b,a);throw"oldItem not found";},removeItem:function(c){c=this.indexOf(c);return-1!==c?this.removeAt(c):this},clear:function(){var c=this.get();c.splice(0,c.length);r(this.context,this.context,"init");return this},count:function(){return this.get().length},sort:function(c,a){return f.raiseEvent(this.context,this.context,
"init",this.get().sortObject(c,a))}});F.prototype={constructor:F,mainModel:function(){return m.get(this.mainPath)}};t(f,{fn:R,accessor:v,toPhysicalPath:o,toLogicalPath:U,clearObj:function a(b){if(B(b))return null;for(var d in b)y.call(b,d)&&(b[d]=a(b[d]));return b},isUndefined:C,isPrimitive:B,isString:p,isObject:u,shadowNamespace:function(){return j},Shadow:F,modelCleanups:[function(a){for(var b in i)i[b].remove(a),0===i[b].length&&delete i[b];for(var d in i)d.beginsWith(a)&&delete i[d];a.beginsWith(j)||
m.del(j+"."+a.replace(T,"_"))}],addRef:function(a,b){a=o(a);b=o(b);i[b]=i[b]||[];i[b].pushUnique(a);return this},removeRef:function(a,b){a=o(a);b=o(b);i[b].remove(a);i[b].length||delete i[b];return this},modelReferences:i,options:function(a,b){if(a===k)return A;if(u(a))return t(A,a),a;if(1===arguments.length)return A[a];if(b===k)delete A[a];else return A[a]=b},pureModel:function(a,b){var d=t({},m.get(!0,a));delete d[j];d=JSON.stringify(d);return b?d:JSON.parse(d)},empty:function(){for(var a in D)a!==
j&&m.del(a,!0)}});m=new x("");var ga=/(\w+)?(\*?)(\.?)([^\s]*)/,ma=/^(.+)\.\w+$/,na=/^.+\.(\w+)$|\w+/,M={},O=S.RegExp,q={},N={},Y=/\s*\|\s*/,ha=/^\w+(?!\w*\.\w+)/,oa=/^(\w+)\.?/,z=h.fn;r=function(a,b,d,e,g){a=new w(a,b,d,e,g);W(a);if(a.continueEventing&&a.bubbleUp)for(a.eventType=oa.exec(a.eventType)[1]+".child";((b=f.contextOfPath(a.path))||1)&&!(a.path=b,W(a),!a.continueEventing||!a.bubbleUp||""===b););return a};w.prototype={constructor:w,targetProxy:function(){return f(this.target)},targetValue:function(a){return f().get(a,
this.target)},targetContext:function(){return f.contextOfPath(this.target)},targetIndex:function(){return f.indexOfPath(this.target)},bubbleUp:!0,continueEventing:!0,hasError:!1,currentValue:function(a){return f().get(a,this.path)},currentProxy:function(){return f(this.path)},isModelEmpty:function(){var a=this.options,a=a?p(a)?"true"===a:!!a:!1;return this.currentProxy().isModelEmpty(a)}};P(M);t(f,{addModelHandler:function(a,b,d,e,g){if("once"===b)return this.renderViews(a,d,e,g);if(p(d)||n(d))g=
e,e=d,d=M;"_"===g&&(g=k);a=o(a,!0);d=h(d);0<d.length&&!q[a]&&(q[a]=[]);d.each(function(){g=Z(this,e,g);P(this);q[a].push({view:this,modelHandler:e,modelEvents:b,options:g});X(b,"init")&&L(this,e,new w({path:a,target:a,eventType:"init",options:g}))});return f},removeModelHandler:function(a){if(p(a)){var a=o(a),b;for(b in q)b.beginsWith(a)&&delete q[b]}else u(a)&&h(a).each(function(a,b){if(H(b))for(var g in q){for(var f=q[g],h=f.length-1;0<=h;h--)f[h].view===b&&f.splice(h,1);0===f.length&&delete q[g]}});
return f},getModelHandlerData:function(a){if(p(a))return q[o(a)];if(u(a)){if(!H(a))return;var b,d;for(d in q)for(var e=q[d],g=e.length-1;0<=g;g--)e[g].view===a&&(b=b||{},b[d]=b[d]||[],b[d].push(e[g]));return b}if(!a)return q},renderViews:function(a,b,d,e){a=o(a,!0);h(b).each(function(){e=Z(this,d,e);L(this,d,new w({path:a,target:a,eventType:"init",options:e}))});return f},ModelEvent:w,commonModelHandlers:N,raiseEvent:r,indexOfPath:function(a){a=na.exec(a);return a[1]||a[0]},contextOfPath:function(a){return(a=
ma.exec(a))&&a[1]||""}});f.modelCleanups.push(f.removeModelHandler);z.addModelHandler=function(a,b,d,e){f.addModelHandler(a,b,this,d,e);return this};z.renderViews=function(a,b,d){f.renderViews(a,this,b,d);return this};var Q={},$={},s={};I.prototype={constructor:I,targetProxy:function(){return f(this.path)},targetValue:function(a){return m.get(a,this.path)},targetContext:function(){return f.contextOfPath(this.path)},targetIndex:function(){return f.indexOfPath(this.path)},updateModel:function(a){return m.update(this.path,
a)},returnFalse:function(){this.e.stopPropagation();this.e.preventDefault()},stopPropagation:function(){this.e.stopPropagation()},stopImmediatePropagation:function(){this.e.stopImmediatePropagation()}};t(f,{addViewHandler:function(a,b,d,e,g){var d=o(d,!0),i=e;"_"===g&&(g=k);p(e)&&e.beginsWith("*")&&(e=Q[e.substring(1)]);n(e.buildOptions)&&(g=e.buildOptions(a,g));n(e.initialize)&&e.initialize(a);b=h.map(b.split(Y),function(a){return a+"."+j+"."+d}).join(" ");h(a).each(function(){P(this);h(this).bind(b,
{viewHandler:e,path:d,options:g,originalHandler:i},ia);s[d]=s[d]||[];s[d].pushUnique(this)});return f},removeViewHandler:function(a){p(a)?(a=o(a),h(s[a]).unbind("."+j+"."+a),delete s[a]):u(a)&&(h(a).unbind("."+j),h(a).each(function(){for(var a in s)s[a].remove(this)}));return f},removeView:function(a){h(a).each(function(a,d){H(this)&&(f.removeModelHandler(d).removeViewHandler(d),h(this).removeData(j))});return f},commonViewHandlers:Q,valueConverters:$,ViewEvent:I,getViewHandlerData:function(a){if(p(a))return s[a];
if(u(a)){if(!H(a))return;var b=[],d;for(d in s)y.call(s,d)&&s[d].contains(a)&&b.push(d);return b}if(!a)return s},getHandlerData:function(a){var b=f.getModelHandlerData(a),d=f.getViewHandlerData(a);if(p(a)){for(var e,a=0;a<b.length;a++)e=e||[],e.pushUnique(b[a].view);return{viewsToBeUpdated:e,viewsUpdatingMe:d}}var g,h;for(h in b)g=g||[],g.pushUnique(h);return{pathsUpdatingMe:g,pathsToBeUpdated:d}}});f.modelCleanups.push(f.removeViewHandler);var pa=h.cleanData;h.cleanData=function(a){f.removeView(a);
pa(a)};f.forwardEvent=function(a,b,d){var e=function(a){d(a)&&h(a.target).trigger(t({},a,{type:b,currentTarget:a.target}))};if(h.event.special[b])throw"event '"+b+"' has been defined";h.event.special[b]={setup:function(){h(this).bind(a,e)},teardown:function(){h(this).unbind(a,e)}};return f};f.addViaEvent=function(a,b){h.event.special[a]={setup:function(){h(this).bind(b,a,aa)},teardown:function(){h(this).unbind(b,aa)}};return f};z.addViewHandler=function(a,b,d,e){f.addViewHandler(this,a,b,d,e);return this}}(jQuery,
window);
