<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>Declarative subscription</title>
	<link href="../demo/css/oocss.css" rel='stylesheet'/>
	<link rel="stylesheet" type="text/css" href="introduction.css" media="all">
	<link href='../demo/SyntaxHighlighter/styles/shCore.css' rel='stylesheet'/>
	<link href='../demo/SyntaxHighlighter/styles/shThemeDefault.css' rel='stylesheet'/>
	<script src='../demo/SyntaxHighlighter/scripts/XRegExp.js'></script>
	<script src='../demo/SyntaxHighlighter/scripts/shCore.js'></script>
	<script src='../demo/SyntaxHighlighter/scripts/shBrushJScript.js'></script>
	<script src='../demo/SyntaxHighlighter/scripts/shBrushXml.js'></script>
	<script src='../demo/SyntaxHighlighter/scripts/shBrushCss.js'></script>
	<script src='analytic.js'></script>
	<script language="javascript" type="text/javascript">
		SyntaxHighlighter.defaults.gutter = false;
		SyntaxHighlighter.defaults.toolbar = false;
		SyntaxHighlighter.config.bloggerMode = true;
		SyntaxHighlighter.all();
	</script>
</head>
<body>
<div class="page oldSchool">

<h2>Declarative Subscription</h2>

<p>Subscription can be also built declaratively. There is no techincal difference
	between declarative subscription and programatic subscription. Whatever you can achieve in
	declarative subscription , you can do it in programatic subscription, and vice versa. However
	declariave subscription offer the following unique benefits.</p>

<ol class="simpleList">
	<li>There is no need to select a view using a selector (such as id).</li>
	<li>Better support template, especially nested template</li>
	<li>Minimize coding by using custom property and class property</li>
</ol>


<p>
	When designing syntax of declarative subscriptions, I have the following goals.
</p>
<ol class="simpleList">
	<li>We can embed all programatic subscriptions into the markup</li>
	<li>The data embedded into the markup must be as compact as possible, while still semantic
		enough to understand.
	</li>
	<li>The syntax used in the delcarative subscriptions must be extensible.</li>
</ol>

<p>To achieve these goals, via.js borrow some css synatax.</p>

<h3>Subscription rule</h3>

<p>The subscription rule is saved in a "data-sub" attribute of DOM element. Like css rule, a
	subscription rule consist of multiple declarations. Each declaration has a
	propety and a vlaue, a property begin with "@". the following subscrition rule define two
	declarations
</p>

<pre class="brush:javascript">
	@propertyOne:valueOne
	@propertyTwo:valueTwo
</pre>

<h3>Whitespace</h3>

<p>Generally whitespaces (such as tab, line-feed) between declarations are ignored, so feel free to
	use them to make your code more readable like below. However, the space within a declaration
	value can be significant.</p>

<pre class="brush:javascript">
	&lt;a data-sub="@ns:x
	             @sub:x|init afterUpdate|handler|options one, two
	             @pub:click|y|handler|option 1,2 3"

	/&gt;
</pre>


<h3>System subscription properties</h3>

<p>There are 4 system subscription properties, they are as following.</p>

<ol class="simpleList">
	<li>@ns</li>
	<li>@sub or !events</li>
	<li>@pub or events</li>
	<li>@class or `className</li>
</ol>


<h4>@ns</h4>

<p>@ns defines the model namespace that the parser will use to build subscriptions. It is an
	optional property. If @ns is missing, then it inherites from the first ascendant with this
	property. If all ascendent does not have @ns property set, then @ns is set to empty string,
	which means root model. With namespace, the path value in other subscription rule is based on
	the namespace.
</p>
<pre class="brush:javascript">
	data-sub="@ns:myNamespace"
</pre>
<h4>@sub or !events</h4>

<p>The "@sub" property means the current element subscribe to the events of another object
	(view or model). Here is the syntax and some example</p>

<pre class="brush:javascript">
	//handler, options, delegate are all optional, you can have multiple @sub declaration
	data-sub="@sub:publisher1|events1|handler1|options1|delegateSelector1
			  @sub:publisher2|events2|handler2|options2|delegateSelector2"

	//or combine mulitple @sub declarations into one using seperator ";"
	data-sub="@sub:publisher1|events1|handler1|options1|delegateSelector1;
				   publisher2|events2|handler2|options2|delegateSelector2"


	//view subscribe model
	//current element subscribe model: "message", event: afterUpdate, handler:get html
	data-sub="@sub:message|afterUpdate|html"

	//view subscribe view event
	//current element subscribe view "#txtName", event:change, handler:val html
	data-sub="@sub:$#txtName|change|val html"

	//options has not value, but delegateSelector has value
	data-sub="@sub:$div|click|*alert||input[type='button']
</pre>

<p>The value of @sub property is a string seperated by "|". The publisher can be a model path
	relative
	to the namespace or it can be a jQuery selector(prefix with $, e.g $#txtName). The second part
	is events. It can be model event or jQuery event. Handler, options, and delegateSelector are all
	optional.
</p>

<p>Besides the "@sub" notation, we can also use "!events" to do the same thing, but it is
	shorter, which is recommended, but the "!events" will be converted to "@sub" eventually.</p>

<pre class="brush:javascript">
	data-sub="!events:publisher|handler|option|delegate"
	//
	data-sub="!afterUpdate:message|html"
</pre>

<h4>@pub or $events</h4>

<p>The "@pub" property means current element publishing jQuery events to another object (view or
	model). Another way to understand it is the current element's event is subscribed by an other
	publisher. Here is the syntax and some example.
</p>

<pre class="brush:javascript">
	//handler, options, delegate are all optional, you can have multiple @pub declaration
	data-sub="@pub:jQueryEvents1,subscriber1,handler1,options1|delegate1
			  @pub:jQueryEvents2,subscriber2,handler2,options2|delegate2"

	//or combine multiple @pub declarations into one using seperator ";"
	data-sub="@pub:jQueryEvents1,subscriber1,handler1,options1|delegate1;
				   jQueryEvents2,subscriber2,handler2,options2|delegate2"

	//current view publishes "change" event to model "name", with handler "val"
	data-sub="@pub:change|name|val"
</pre>

<p>We can aslo use "$events" to replace "@pub", so that the syntax is shorter.</p>

<pre class="brush:javascript">
	data-sub="$event:selector|handler|option|delegate"
	//
	data-sub="$change:name|val"
</pre>


<h4>@class</h4>

<p>These property is a special property for extentions, we will talk about this later.</p>

<h3>User subscription properties</h3>

<p>Besides the four system subscription properties, we can create our user subscriptions property.
	The following the code in via.js which create user subscription property @confirm.
</p>


<pre class="brush:javascript">
	via.userSubsProps.confirm = function( elem, parseContext, subscriptions, options ) {
		subscribe( parseContext.ns, elem, "click", "*confirm", options );
	};
</pre>

<pre class="brush:html">
	&lt;input type="button" data-sub="@confirm:Go ahead?" value="Ok" /&gt;
</pre>

<p>User subscription properties is good extension point to allow us dynamically
	create subscriptions when can be not achieved by using system subscription properties.
	It can be also used to inject some logic such as initialization during subscriptions is built.
	We will talk about this advanced topic later.
</p>

<h3>Package subscription rules with @class property</h3>

<p>Subscription rule is not code by itself, its just some configuration information. However,
	if we have many declarations in data-sub attribute, it is error prone.
	To solve this problem, via.js can borrow the CSS practise. One way to apply CSS is to
	to use inline style which put lots style properties into the style attribute. A better
	practise is to apply a class to the element, and create a class rule with a set of css
	declarations in an external css style sheet. By doing this, our markup is clean and semantic.
</p>

<p>Here, we try to do simliar thing with with <strong>@class</strong> property. We can create a
	class property by aggregating a set of subscription delarations (including nested class
	declarations) into a string, and give it a class name. After that we can apply the class to an
	element by using class declaration. The following shows how to create a class, and how to use it
	in class declaration.
</p>

<pre class="brush:javascript">
	via.classes.class1 = "..subscription declarations..";
	data-sub="@class:class1|namespace|options|delegate";


	via.classes.myClass = "@ns:x @pub:change|firstName|val" +
						        "@sub:firstName|init|val";
	// "@class" declaration
	data-sub="@class:myClass|modelPath|options|delegate"

	//you can have multiple @class for an element
	data-sub="@class:class1|modelPath1|options1|delegate1
	          @class:class2|modelPath2|options2|delegate2"

	//or you can group multiple @class rule into one using seperator ";"
	data-sub="@class:class1|modelPath1|options1|delegate1;
	                 class2|modelPath2|options2|delegate2"

</pre>

<p>Another way to reference to a class is to use <strong>`className:.</strong>, instead of
	<strong>@class:className:.</strong>, like the following, this will make the subscription
	rule event more compact</p>

<pre class="brush:javascript">
	data-sub="`myClass:modelPath|options"

	data-sub="`class1:modelPath1|options1|delegate1
			  `class2:modelPath2|options2|delegate2"

	via.classes.datepicker = "@sub:.|init afterUpdate|*modelToDatepicker" +
							 "@pub:onDateChanged|.|*datepickerToModel";

	via.classes.dateVal = "@sub:.|init afterUpdate|get val *dateToString" +
						  "@pub:change|.|val set *stringToDate";

	via.set( "meetingDate", new Date( "2012-1-1" ) );
</pre>

<pre class="brush:html">
	&lt;p&gt;&lt;span data-sub="`datepicker:meetingDate"/&gt;&lt;/p&gt;
	&lt;input type="text" data-sub="`dateVal:meetingDate"/&gt;
</pre>

<p>Combining user subscription property and class property, we can make our subscription data
	shorter, more readable, and more reusable. via.js actually use this both of them to deploy
	lots of subscription declarations.
</p>

<p>Let's revisit the hello world, and see how to the declarative subscription can be simplified with
	what we cover above. The <a
		href="../demo/helloworld/08-event-subscriptions-between-model-view-declarative0.html">following</a>
	use the original @pub and @sub property.</p>

<pre class="brush:html">
	&lt;div data-sub="@ns:test"&gt;
		&lt;label&gt;Please input your name:
		&lt;input type="text" data-sub="@pub:change|name|val"/&gt;
		&lt;/label&gt;
		&lt;div data-sub="@sub:message|afterUpdate|html"/&gt;
	&lt;/div&gt;
</pre>

<p>The <a href="../demo/helloworld/08-event-subscriptions-between-model-view-declarative1.html">following</a>
	use the !events and $events shortcut.</p>

<pre class="brush:html">
&lt;div data-sub="@ns:helloApp"&gt;
	&lt;label&gt;Please input your name: &lt;input type="text" data-sub="$change:name|val"/&gt;
	&lt;/label&gt;

	&lt;div id="divMessage" data-sub="!afterUpdate:message|html"/&gt;
&lt;/div&gt;
</pre>

<p>The <a href="../demo/helloworld/08-event-subscriptions-between-model-view-declarative1.html">following</a>
	use class property and custom property.</p>


<pre class="brush:html">
	&lt;div data-sub="@ns:helloApp"&gt;
		&lt;label&gt;Please input your name: &lt;input type="text" data-sub="`val:name"/&gt;
		&lt;/label&gt;

		&lt;div id="divMessage" data-sub="`html:message"/&gt;
	&lt;/div&gt;
</pre>

<p>The syntax of declarative subscription may not be as simple as the declarative binding of
	knockoutjs, but it has lots machanism to extend yet main compact.
</p>

<p>Next I will talk about <a href="template.html">template</a></p>

</div>
</body>
</html>
